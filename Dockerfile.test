# Lightweight test runner image
FROM python:3.13-slim

# Install Poetry
ENV POETRY_HOME="/opt/poetry" \
    POETRY_VERSION="1.8.2" \
    POETRY_VIRTUALENVS_CREATE=false \
    PYTHONPATH=/app

RUN pip install --no-cache-dir poetry==${POETRY_VERSION}

WORKDIR /app

# Copy dependency files first for caching
COPY pyproject.toml poetry.lock ./

# Install only main + test dependencies (no infra/CDK)
# No root install needed â€” volume mount provides source at runtime, PYTHONPATH makes it importable
RUN poetry install --only main,dev --no-root --no-interaction --no-ansi

# Default command: run pytest
CMD ["pytest", "-v", "--tb=short"]
